<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Cat√©gorie - Wiki SGPI</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="dark-mode">

    <header>
        <div class="header-content">
            <h1><a href="index.html">üìö Wiki SGPI</a></h1>
            <div class="header-actions">
                <a href="account.html" style="margin-right: 16px; padding: 8px 16px; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text-primary); text-decoration: none; font-size: 0.9rem;">Mon compte</a>
                <button id="logout-btn" class="logout-btn">D√©connexion</button>
                <button id="theme-toggle" aria-label="Changer de th√®me">
                    <span class="icon-sun">‚òÄÔ∏è</span>
                    <span class="icon-moon">üåô</span>
                </button>
                <button id="menu-toggle" class="mobile-only" aria-label="Menu">‚ò∞</button>
            </div>
        </div>
    </header>

    <div class="container">
        
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <input type="text" id="search" placeholder="üîç Rechercher..." autocomplete="off">
            </div>

            <nav class="nav-categories">
                <h3>Cat√©gories</h3>
                <ul id="sidebar-categories">
                    <li style="text-align: center; color: var(--text-secondary);">Chargement...</li>
                </ul>
            </nav>

            <div class="toc" id="toc" style="display: none;">
                <h3>Sur cette page</h3>
                <ul id="toc-list"></ul>
            </div>
        </aside>

        <main class="main-content category-page">
            
            <div id="loading" style="text-align: center; padding: 60px; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 20px;">‚è≥</div>
                <p>Chargement...</p>
            </div>

            <div id="error" style="display: none; text-align: center; padding: 60px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">‚ùå</div>
                <h2 style="color: var(--text-primary); margin-bottom: 10px;">Cat√©gorie introuvable</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Cette cat√©gorie n'existe pas ou a √©t√© supprim√©e.</p>
                <a href="index.html" style="display: inline-block; padding: 12px 24px; background: var(--accent); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">‚Üê Retour √† l'accueil</a>
            </div>

            <div id="content" style="display: none;">
                <h2 id="category-title"></h2>
                <div id="sections-container"></div>
            </div>

        </main>

    </div>

    <button id="back-to-top" class="back-to-top" aria-label="Retour en haut">‚Üë</button>

    <footer>
        <p>¬© 2026 SGPI - Wiki √† usage priv√© | R√©serv√© aux membres Discord</p>
        <p>Derni√®re mise √† jour : F√©vrier 2026</p>
    </footer>

    <script src="script.js"></script>
    
    <script>
        
        // R√©cup√©rer le slug depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');
        
        if (!slug) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        } else {
            loadCategory(slug);
        }
        
        // Charger les cat√©gories pour la sidebar
        async function loadSidebarCategories() {
            try {
                const res = await fetch(`${API_URL}/api/categories`);
                const data = await res.json();
                
                if (res.ok && data.categories) {
                    const ul = document.getElementById('sidebar-categories');
                    ul.innerHTML = data.categories.map(cat => {
                        const isActive = cat.slug === slug ? 'class="active"' : '';
                        return `<li><a href="category.html?slug=${cat.slug}" ${isActive}>${cat.emoji} ${cat.name}</a></li>`;
                    }).join('');
                }
            } catch (err) {
                console.error('Erreur chargement sidebar:', err);
            }
        }
        
        // Charger la cat√©gorie
        async function loadCategory(slug) {
            try {
                const res = await fetch(`${API_URL}/api/categories/${slug}`);
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error);
                }
                
                const category = data.category;
                
                // Titre de la page
                document.getElementById('page-title').textContent = `${category.emoji} ${category.name} - Wiki SGPI`;
                document.getElementById('category-title').innerHTML = `${category.emoji} ${category.name}`;
                
                // Support structure 3 niveaux OU ancienne structure
                const subCategories = category.subCategories || category.sections || [];
                
                // G√©n√©rer la sidebar TOC avec accord√©ons
                generateSidebarTOC(subCategories);
                
                // G√©n√©rer le contenu principal
                const sectionsContainer = document.getElementById('sections-container');
                
                if (subCategories.length === 0) {
                    sectionsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Aucun contenu dans cette cat√©gorie. <a href="admin-unified.html">Ajouter du contenu</a></p>';
                } else {
                    sectionsContainer.innerHTML = renderSubCategories(subCategories);
                }
                
                // Afficher le contenu
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Init accord√©ons
                initAccordions();
                
            } catch (err) {
                console.error('Erreur chargement cat√©gorie:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }
        
        // G√©n√©rer la sidebar TOC avec accord√©ons
        function generateSidebarTOC(subCategories) {
            const tocList = document.getElementById('toc-list');
            
            if (subCategories.length === 0) {
                document.getElementById('toc').style.display = 'none';
                return;
            }
            
            let html = '';
            
            subCategories.forEach(subCat => {
                const subSubCats = subCat.subSubCategories || [];
                const hasSubSub = subSubCats.length > 0;
                
                // Compter les liens
                let totalLinks = 0;
                if (hasSubSub) {
                    subSubCats.forEach(subSubCat => {
                        const links = subSubCat.links || [];
                        totalLinks += links.length;
                    });
                } else {
                    // Ancienne structure (sections avec links directs)
                    const links = subCat.links || [];
                    totalLinks = links.length;
                }
                
                html += `
                    <li class="toc-subcat ${hasSubSub ? 'has-children' : ''}">
                        <div class="toc-subcat-header" onclick="toggleTocSubCat('${subCat.id}')">
                            <span class="toc-arrow">${hasSubSub ? '‚ñ∂' : '‚Ä¢'}</span>
                            <a href="#subcat-${subCat.id}">${subCat.name}</a>
                            <span class="toc-count">${totalLinks}</span>
                        </div>
                        ${hasSubSub ? `
                            <ul class="toc-subsubcat-list" id="toc-subsubcat-${subCat.id}" style="display: none;">
                                ${subSubCats.map(subSubCat => {
                                    const links = subSubCat.links || [];
                                    return `
                                        <li class="toc-subsubcat">
                                            <a href="#subsubcat-${subSubCat.id}">
                                                ${subSubCat.name}
                                                <span class="toc-count">${links.length}</span>
                                            </a>
                                        </li>
                                    `;
                                }).join('')}
                            </ul>
                        ` : ''}
                    </li>
                `;
            });
            
            tocList.innerHTML = html;
            document.getElementById('toc').style.display = 'block';
        }
        
        // Toggle accord√©on sidebar
        function toggleTocSubCat(id) {
            const list = document.getElementById('toc-subsubcat-' + id);
            const arrow = event.currentTarget.querySelector('.toc-arrow');
            
            if (list) {
                const isVisible = list.style.display !== 'none';
                list.style.display = isVisible ? 'none' : 'block';
                arrow.textContent = isVisible ? '‚ñ∂' : '‚ñº';
            }
        }
        
        // Rendre les sous-cat√©gories (3 niveaux)
        function renderSubCategories(subCategories) {
            return subCategories.map(subCat => {
                const subSubCats = subCat.subSubCategories || [];
                
                if (subSubCats.length > 0) {
                    // Structure 3 niveaux
                    return `
                        <section id="subcat-${subCat.id}" class="subcategory-section">
                            <h3 class="subcategory-title">${subCat.name}</h3>
                            ${renderSubSubCategories(subSubCats)}
                        </section>
                    `;
                } else {
                    // Ancienne structure (sections avec liens directs)
                    const links = subCat.links || [];
                    return `
                        <section id="subcat-${subCat.id}" class="subcategory-section">
                            <h3 class="subcategory-title">${subCat.name}</h3>
                            ${links.length === 0 ? 
                                '<p style="color: var(--text-secondary); font-style: italic;">Aucun lien.</p>' :
                                `<ul class="resource-list">
                                    ${links.map(link => renderLink(link)).join('')}
                                </ul>`
                            }
                        </section>
                    `;
                }
            }).join('');
        }
        
        // Rendre les sous-sous-cat√©gories
        function renderSubSubCategories(subSubCats) {
            return subSubCats.map(subSubCat => {
                const links = subSubCat.links || [];
                
                return `
                    <div id="subsubcat-${subSubCat.id}" class="subsubcategory-section">
                        <h4 class="subsubcategory-title">${subSubCat.name}</h4>
                        ${links.length === 0 ? 
                            '<p style="color: var(--text-secondary); font-style: italic; margin-left: 20px;">Aucun lien.</p>' :
                            `<ul class="resource-list">
                                ${links.map(link => renderLink(link)).join('')}
                            </ul>`
                        }
                    </div>
                `;
            }).join('');
        }
        
        // Rendre un lien
        function renderLink(link) {
            return `
                <li>
                    <a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.name}</a>
                    ${link.badge ? ` <span class="badge">${link.badge}</span>` : ''}
                    ${link.description ? ` <span class="link-description">- ${link.description}</span>` : ''}
                </li>
            `;
        }
        
        // Init accord√©ons
        function initAccordions() {
            // Ajouter des styles pour les accord√©ons
            if (!document.getElementById('accordion-styles')) {
                const style = document.createElement('style');
                style.id = 'accordion-styles';
                style.textContent = `
                    .toc-subcat {
                        margin: 0;
                        padding: 0;
                    }
                    
                    .toc-subcat-header {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 8px 12px;
                        cursor: pointer;
                        border-radius: 6px;
                        transition: background 0.2s;
                    }
                    
                    .toc-subcat-header:hover {
                        background: var(--bg-hover);
                    }
                    
                    .toc-arrow {
                        font-size: 0.8rem;
                        width: 16px;
                        transition: transform 0.2s;
                    }
                    
                    .toc-count {
                        margin-left: auto;
                        font-size: 0.85rem;
                        color: var(--text-secondary);
                        background: var(--bg-hover);
                        padding: 2px 8px;
                        border-radius: 12px;
                    }
                    
                    .toc-subsubcat-list {
                        list-style: none;
                        padding-left: 24px;
                        margin: 0;
                    }
                    
                    .toc-subsubcat {
                        margin: 0;
                    }
                    
                    .toc-subsubcat a {
                        display: flex;
                        align-items: center;
                        padding: 6px 12px;
                        border-radius: 6px;
                        transition: background 0.2s;
                    }
                    
                    .toc-subsubcat a:hover {
                        background: var(--bg-hover);
                    }
                    
                    .subcategory-section {
                        margin-bottom: 48px;
                    }
                    
                    .subcategory-title {
                        color: var(--accent);
                        border-bottom: 2px solid var(--accent);
                        padding-bottom: 12px;
                        margin-bottom: 24px;
                    }
                    
                    .subsubcategory-section {
                        margin-bottom: 32px;
                        margin-left: 20px;
                    }
                    
                    .subsubcategory-title {
                        font-size: 1.1rem;
                        color: var(--text-primary);
                        margin-bottom: 12px;
                        padding-left: 12px;
                        border-left: 3px solid var(--accent);
                    }
                    
                    .badge {
                        font-size: 0.9rem;
                        margin-left: 4px;
                    }
                    
                    .link-description {
                        color: var(--text-secondary);
                        font-size: 0.9rem;
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Exposer la fonction toggle globalement
        window.toggleTocSubCat = toggleTocSubCat;
        
        loadSidebarCategories();
    </script>
</body>
</html>
